/*! alphacronke 24-10-2014 */
function Controller(){var a,b,c,d,e,f,g,h=this;this.model=new Model,this.initModel(),this.storyWords=new StoryWords,a=new Panel("#panel-alpharange"),this.alphaRange=new AlphaRange("#dd"),this.alphaRange.addSelectListener(function(a){h.storyWords.highlightWords(a)}),b=new Panel("#panel-a"),d=new SelectSize("#select-chart-size"),d.setCallback(function(a){h.storyWords.setSize(Number(a))}),e=new StoryPartSelect("#story-parts-opts"),e.setCallback(function(a){h.storyWords.setSection(h.model.story[a]),h.storyWords.highlightWords(h.alphaRange.selectedElements)}),f=new SelectStyle("#panel-a #styles"),f.setCallback(function(b){h.storyWords.setStyle(b),"bubble"===b?(h.alphaRange.hide(),d.show(),a.hide()):"alphaSelect"===b&&(a.show(),h.alphaRange.show(),d.hide(),h.storyWords.highlightWords(h.alphaRange.selectedElements))}),c=new MessagePanel("#message-panel"),c.position(window.innerWidth-450,window.innerHeight-200),g=new Message("#message"),g.set("<h3>"+this.model.about.title+"</h3><p>"+this.model.about.description+'</p><address class="author">'+this.model.about.author+'</address><a href="/about/" target="new">more...</a>'),this.actionBar=new ActionBar([{title:"About AlphaCronke",action:function(){g.show(),c.show()}},{title:"Letter Select",action:function(){alphaRange.show(),a.show()}},{title:"Main Panel",action:function(){b.show()}}])}function Model(){this.story={intro:null,partOne:null,partTwo:null,partThree:null},this.about={title:"AlphaCronke",description:"Experimental text viewing with the story, 'Dickory Cronke' by Daniel Defoe.",author:"Goatstone 2014",moreLink:"/about"}}function SelectSize(a){var b=this.setRoot(a),c=this;b.querySelector("input").addEventListener("change",function(a){c.select(a.target.value)})}function SelectStyle(a){var b=this.setRoot(a),c=this;b.addEventListener("change",function(){c.select(this.value)})}function StoryPartSelect(a){var b=this.setRoot(a),c=this;b.addEventListener("change",function(){c.select(this.value)})}function StoryWords(){this.words,this.sectionsWords=[],this.wordConfig={backgroundColorOff:"#444",backgroundColorOn:"#ccc"},this.bubbleData={children:[]},this.styleTypes=["bubble","alphaSelect"],this.selectedStyle=this.styleTypes[1],this.reString=null,this.size=700}function MessagePanel(a){this.setDom(a)}function ActionBar(a){this.$showMenu=document.querySelector("#action-bar .icon-overflow"),this.initActionBar(),this.actionMenu=new ActionMenu(a)}function ActionMenu(a){var b=this;this.$root=document.querySelector("#action-menu"),this.$body=document.querySelector("body");for(var c=0;c<a.length;c++){var d=document.createTextNode(a[c].title),e=document.createElement("LI"),f=document.createAttribute("data-index");f.value=c,e.setAttributeNode(f),e.appendChild(d),this.$root.querySelector("ul.action-menu-main").appendChild(e)}this.$root.querySelector("ul").addEventListener("click",function(b){var c=b.target.dataset.index;a[c].action()}),this.$body.addEventListener("mousedown",function(){"visible"===b.$root.style.visibility&&(b.$root.style.visibility="hidden")}),this.$root.addEventListener("mousedown",function(a){a.stopPropagation()})}function AlphaRange(a){this.config={width:410,height:35,color:d3.rgb(30,30,30),scaleSymbols:{colorOn:d3.rgb(255,255,255),colorOff:d3.rgb(0,0,0),listStartX:20,listWidth:390},selector:{arc:{color:d3.rgb(20,100,225),opacity:.6},selectedWindow:{color:d3.rgb(250,0,0),opacity:.3}}},this.dDivDims=[{x:20,y:window.innerHeight-140}];this.setRoot(a);this.ordinalScale,this.ordinalGroup,this.linearScale,this.brush,this.initExtent=[.5,.9],this.onSelectCallback=null,this.alphabet="abcdefghijklmnopqrstuvwxyz".split(""),this.selectedElements="",this.prevSelectedElements=null,this.linearScale=d3.scale.linear().range([20,390]),this.ordinalScale=d3.scale.ordinal().domain(this.alphabet).rangeBands([0,1],0,0),this.initDraw(),this.setSelectedElements()}function Component(){}function Message(a){this.setRoot(a)}function Panel(a){a&&this.setDom(a)}Controller.prototype.initModel=function(){var a=this;d3.text("/datum/dickory_cronke.txt",function(b){var c=[],d=738,e=59570,f=b.substr(d,e);f=f.replace(/\r/g,""),f=f.replace(/([^\n])[\n]([^\n])/g,"$1 $2"),c=f.split(/[\n][\n]/g),a.model.story.intro=c.slice(0,16),a.model.story.partOne=c.slice(17,74),a.model.story.partTwo=c.slice(75,129),a.model.story.partThree=c.slice(130,172),c=null,f=null,a.storyWords.setSection(a.model.story.intro),a.storyWords.highlightWords(a.alphaRange.selectedElements)})},window.addEventListener("load",function(){new Controller}),SelectSize.prototype=Object.create(Component.prototype),SelectStyle.prototype=Object.create(Component.prototype),StoryPartSelect.prototype=Object.create(Component.prototype),StoryWords.prototype.setStyle=function(a){this.selectedStyle=a,this.clearContent(),this.generateBGround()},StoryWords.prototype.setSize=function(a){this.size=a,this.generateBubbleWord(Number(a))},StoryWords.prototype.setSection=function(a){var b=this,c=a;this.clearContent(),this.sectionsWords=[],c.forEach(function(a){b.sectionsWords.push(a.split(" "))}),this.generateBGround()},StoryWords.prototype.setBubbleWordData=function(){var a={};this.bubbleData.children=[];var b=["","a","the","and","in","of","to","that","is","be","if","as","his","this"];this.sectionsWords.forEach(function(c){c.forEach(function(c){-1!==b.indexOf(c)||(a[c.toLowerCase()]?a[c.toLowerCase()]++:a[c.toLowerCase()]=1)})});for(var c in a){var d={name:c+"",value:a[c]+""};this.bubbleData.children.push(d)}},StoryWords.prototype.generateBGround=function(){"bubble"===this.selectedStyle?(this.setBubbleWordData(),this.generateBubbleWord(window.innerHeight)):"alphaSelect"===this.selectedStyle&&this.generateSelectWord()},StoryWords.prototype.generateBubbleWord=function(){var a=this.size,b=d3.scale.category20c(),c=d3.layout.pack().sort(null).size([a,a]).padding(1.5);d3.select("svg.bubble").remove();var d=d3.select("body").append("svg").attr("width",a).attr("height",a).attr("class","bubble"),e=d.selectAll(".node").data(c.nodes(this.bubbleData).filter(function(a){return!a.children})).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});e.append("circle").attr("r",function(a){return a.r}).style("fill",function(a){return b(a.name)}),e.append("text").attr("dy",".3em").style("text-anchor","middle").text(function(a){return a.name}),d3.select(self.frameElement).style("height",a+"px")},StoryWords.prototype.generateSelectWord=function(){var a=d3.select("#story_words").selectAll("p").data(this.sectionsWords).enter().append("p");this.words=a.selectAll("span").data(function(a){return a}).enter().append("span").text(function(a){return a})},StoryWords.prototype.highlightWords=function(a){return this.words?($this=this,this.reString=a.split("").join("|"),void this.words.html(function(a){var b=a.replace(new RegExp("("+$this.reString+")","ig"),'<em style="color:#f40">$1</em>');return b})):!1},StoryWords.prototype.clearContent=function(){d3.select("#story_words").selectAll("p").remove(),d3.select("body").selectAll("svg.bubble").remove()},MessagePanel.prototype=Object.create(Panel.prototype),ActionBar.prototype.initActionBar=function(){var a=this;this.$showMenu.addEventListener("mousedown",function(b){return b.stopPropagation(),a.actionMenu.$root.style.visibility="visible"!==a.actionMenu.$root.style.visibility?"visible":"hidden",!0})},AlphaRange.prototype=Object.create(Component.prototype),AlphaRange.prototype.initDraw=function(){var a,b,c,d=this;this.$root.style.left=this.dDivDims[0].x+"px",this.$root.style.top=this.dDivDims[0].y+"px";var e=d3.select("#dd").selectAll("div#alpha-range").data(this.dDivDims).enter().append("div");e.append("div").attr("id","scale_background"),c=d3.select("#dd").append("svg").attr("width",this.config.width).attr("height",this.config.height).style({left:"0px",top:"7px",position:"relative",opacity:.5}),this.ordinalGroup=c.append("g"),this.ordinalGroup.selectAll("text").data(this.alphabet).enter().append("text").text(function(a){return a}).attr("x",function(a){return 20+363*d.ordinalScale(a)}).attr("y",function(){return d.config.height/2}).attr("fill",this.config.scaleSymbols.colorOff),this.brush=d3.svg.brush().x(this.linearScale).extent(this.initExtent).on("brush",function(){return 1}).on("brushstart",function(){return 1}).on("brushend",function(){return d.setSelectedElements(),1}),a=d3.svg.arc().outerRadius(17.5).startAngle(0).endAngle(function(a,b){return b?-Math.PI:Math.PI}),b=c.append("g").attr("fill",this.config.selector.arc.color).attr("fill-opacity",this.config.selector.arc.opacity).call(d.brush),b.selectAll(".resize").append("path").attr("transform","translate(0,"+this.config.height/2+")").attr("d",a),b.selectAll("rect").attr("fill",this.config.selector.selectedWindow.color).attr("fill-opacity",this.config.selector.selectedWindow.opacity).attr("height",this.config.height).attr("y",0)},AlphaRange.prototype.draw=function(){var a=this;this.ordinalGroup.selectAll("text").text(function(a){return a}).attr("fill",function(b){return-1!==a.selectedElements.indexOf(b)?"red":"black"})},AlphaRange.prototype.addSelectListener=function(a){this.onSelectCallback=a},AlphaRange.prototype.setSelectedElements=function(){var a=this,b=this.brush.extent();this.selectedElements="",this.alphabet.forEach(function(c){a.ordinalScale(c)>=b[0]&&a.ordinalScale(c)<=b[1]&&(a.selectedElements+=c)}),this.selectedElements!==this.prevSelectedElements&&(this.prevSelectedElements=this.selectedElements,null!==this.onSelectCallback&&this.onSelectCallback(a.selectedElements),this.draw())},Component.prototype.setRoot=function(a){return this.$root=document.querySelector(a),this.show(),this.$root},Component.prototype.show=function(){this.$root.style.visibility="visible"},Component.prototype.hide=function(){this.$root.style.visibility="hidden"},Component.prototype.select=function(a){this.callback(a)},Component.prototype.setCallback=function(a){this.callback=a},Message.prototype=Object.create(Component.prototype),Message.prototype.set=function(a){this.$root.innerHTML=a},Panel.prototype.setDom=function(a){this.$root=document.querySelector(a),this.$handle=this.$root.querySelector(".handle"),this.$body=document.querySelector("body"),this.setDrag(),this.show()},Panel.prototype.addComponent=function(a){this.$root.appendChild(a.$root)},Panel.prototype.show=function(){this.$root.style.visibility="visible"},Panel.prototype.hide=function(){this.$root.style.visibility="hidden"},Panel.prototype.position=function(a,b){this.$root.style.left=a+"px",this.$root.style.top=b+"px"},Panel.prototype.setDrag=function(){this.mOffsets=[],this.handleEvent=function(a){switch(a.type){case"mousedown":this.mOffsets[0]=a.clientX-this.$root.offsetLeft,this.mOffsets[1]=a.clientY-this.$root.offsetTop,this.$body.addEventListener("mousemove",this,!1);break;case"mousemove":this.$root.style.left=a.clientX-this.mOffsets[0]+"px",this.$root.style.top=a.clientY-this.mOffsets[1]+"px";break;case"mouseup":this.$body.removeEventListener("mousemove",this,!1)}},this.$handle.addEventListener("mousedown",this,!1),this.$handle.addEventListener("mouseup",this,!1),this.initCloseButton(),this.initBackground()},Panel.prototype.initBackground=function(){var a=this.$root.offsetWidth-40,b=document.createElementNS("http://www.w3.org/2000/svg","svg"),c=2,d=4;for(b.setAttribute("class","main-background"),b.setAttribute("width",a),b.setAttribute("height","30"),b.style.strokeWidth="2px";d>0;){var e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1","0"),e.setAttribute("y1",c),e.setAttribute("x2",a),e.setAttribute("y2",c),b.appendChild(e),d--,c+=5}this.$handle.appendChild(b)},Panel.prototype.initCloseButton=function(){var a=this,b=document.createElementNS("http://www.w3.org/2000/svg","svg");b.setAttribute("class","close-button"),b.setAttribute("width","20"),b.setAttribute("height","20"),b.style.stroke="#955",b.style.strokeWidth="5px",b.addEventListener("click",function(){a.$root.style.visibility="hidden"});var c=document.createElementNS("http://www.w3.org/2000/svg","line");c.setAttribute("x1","0"),c.setAttribute("y1","0"),c.setAttribute("x2","20"),c.setAttribute("y2","20"),c.style.strokeWidth="5px";var d=document.createElementNS("http://www.w3.org/2000/svg","line");d.setAttribute("x1","20"),d.setAttribute("y1","0"),d.setAttribute("x2","0"),d.setAttribute("y2","20"),d.style.strokeWidth="5px",b.appendChild(c),b.appendChild(d),this.$handle.appendChild(b)};